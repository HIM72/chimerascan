#summary How to run chimerascan
#labels Featured

= Before getting started =

  # Ensure that your chimerascan installation is complete (see [Installation]).
  # Build an index using the chimerascan indexer (see [Installation]).

= Your first run =

We have tested `chimerascan` using the UCSC genome version hg19 and the corresponding UCSC known gene transcriptome annotations.  For the following example, we will assume your created an index (using the `chimerascan_index.py` script) with an output directory `<INDEX_DIR>`.  `Chimerascan` comes packages with some handy test FASTQ files that we prepared from known chimeras.  These are located in the `/tests` subdirectory within the chimerascan download directory. You should first try chimerascan on some of these to ensure that your setup is working.  Note that the test chimeras provided are *human* chimeras and only compatible with indexes generated from the human genome.

== Finding the TMPRSS2-ERG gene fusion in prostate cancer ==

  # Assume you downloaded chimerascan to the directory `DOWNLOAD_DIR`
  # Assume you built the chimerascan index in the directory `INDEX_DIR`

To test chimerascan on the TMPRSS2-ERG discordant reads with the default parameters, run the following command:

{{{
$ <INSTALL_DIR>/bin/chimerascan_run.py --index <INDEX_DIR> <DOWNLOAD_DIR>/tests/vcap_pe_53bp/TMPRSS2-ERG_1.fq <DOWNLOAD_DIR>/tests/vcap_pe_53bp/TMPRSS2-ERG_2.fq <OUTPUT_DIR>
}}}

For example, if I downloaded chimerascan to `/home/john/downloads/chimerascan`, and installed chimerascan to `/home/john/chimerascan` and built and index at '/home/john/chimerascan_hg19_ucsc', I could run chimerascan as follows:

{{{
$ /home/john/chimerascan/bin/chimerascan_run.py --index /home/john/chimerascan_hg19_ucsc /home/john/downloads/chimerascan/tests/vcap_pe_53bp/TMPRSS2-ERG_1.fq /home/john/downloads/chimerascan/tests/vcap_pe_53bp/TMPRSS2-ERG_2.fq t2erg_test
}}}

== Logging messages ==

Currently, chimerascan is in beta testing, and outputs a considerable number of logging messages during runtime.  These will be disabled in a future release.  It is safe to ignore them for now as long as the pipeline finishes successfully.  If all goes well, you will see the following message upon completion:

`2011-02-09 22:04:09,907 - root - INFO - Finished run. Chimeras written to file t2erg/chimeras.ranked.bedpe`

A successful chimerascan run will produce several output files.  Currently, the key output file is a tabular text file named *`chimeras.ranked.bedpe`*.

You can now proceed to look at the output.  There are many columns in the output file, and most users will not be concerned with most of them.  To view an abbreviated results list with key information, run the following command:

{{{
$ cut -f7-8,11-13,30-32,34 ./t2erg/chimeras.ranked.bedpe
uc002yzj.2      uc002yxb.2      TMPRSS2|ERG     180.0   Intrachromosomal        -2802774        180     70      68      182     0.75
}}}

This abbreviated output shows:
  * 5' transcript name
  * 3' transcript name
  * chimera gene symbols separated by '|'
  * weighted coverage of encompassing reads
  * chimera type
  * distance from 5' to 3' partner
  * number of encompassing reads
  * number of spanning reads
  * number of spanning reads that were also detected as encompassing
  * union of encompassing and spanning read IDs (total number of unique reads)
  * score (0.0 - 1.0) based on empirical distribution of coverage and spanning reads


== Full Output ==

The `chimeras.ranked.bedpe` file follows the BEDPE format described by BEDTools, with many extra attributes following the required fields.  The full column description is provided below:

|| *Column#* || *Name* || *Example* || *Description* ||
|| 1 || 5' reference ||  uc002yzj.2 || Gene/chromosome reference 5' partner ||
|| 2 || 5' start || 0 || Start position on 5' reference ||
|| 3 || 5' end || 78 || End position on 5' reference ||
|| 4 || 3' reference || uc002yzb.2 || Gene/chromosome reference for 3' partner ||
|| 5 || 3' start || 311 || Start position on 3' reference ||
|| 6 || 3' end || 5034 || End position on 3' reference ||
|| 7 || Chimera name || TMPRSS2|ERG || 5' and 3' gene/chromosome names separated by a pipe '|' character ||
|| 8 || Weighted coverage || 180.0 || Reads encompassing (not spanning) the fusion junction, where each read is weighted by the number of alternate alignments it had ||
|| 9 || 5' strand || - || strand of 5' partner ||
|| 10 || 3' strand || - || strand of 3' partner ||
|| 11 || chimera type || Intrachromosomal || describes chimera as one of several types, including "Read_Through", "Intrachromosomal", "Interchromosomal", and others ||
|| 12 || distance to 3' partner || -2802774 || distance from 5' to 3' chimera, or 'None' for interchromosomal chimeras ||
|| 13 || encompassing reads || 180 || Unweighted encompassing read count ||
|| 14 || read1 sense/read2 antisense || 91 || Count of instances where read1 in the pair is on the sense strand ||
|| 14 || read2 sense/read1 antisense || 89 || Count of instances where read2 in the pair is on the sense strand ||
|| 15 || multimapping histogram || 180,0,0,0,0,0,0,0 || Histogram of read multimapping counts, with bin sizes increasing by powers of two.  The first value are the number of unique reads.  The second is the number of reads with exactly 2 hits.  The 3rd column is the number of reads with 3-4 hits.  The 4th column is the number of reads with 5-8 hits.  5th: 9-16, 6th: 17-32, 7th: 33-64, 8th: 65-128+ ||
|| 16 || 5' 95% insert size || 67 || 5-95% percentile of insert size range for the 5' partner ||
|| 17 || 3' 95% insert size || 116 || 5-95% percentile of insert size range for the 3' partner ||
|| 18 || 5' exons || 0-0 || Start and end exons (numbered from 5'-> 3') with encompassing reads ||
|| 19 || 3' exons || 3-3 || Start and end exons (numbered from 5'-> 3') with encompassing reads ||
|| 20 || 5' junction permiscuity || 1.0 || fraction of chimeric reads using the 5' junction that are accountable to this 3' partner ||
|| 21 || 3' junction permiscuity || 1.0 || fraction of chimeric reads using the 3' junction that are accountable to this 5' partner ||
|| 22 || Read IDs || <not shown> || semicolon-delimited list of read IDs from the original FASTQ file ||
|| 23 || Read1 Sequences || <not shown> || semicolon-delimited list of encompassing reads from read1 in the pair ||
|| 24 || Read2 Sequences || <not shown> || semicolon-delimited list of encompassing reads from read2 in the pair ||
|| 25 || Read2 Sequences || <not shown> || semicolon-delimited list of encompassing reads from read2 in the pair ||
|| 26 || Junction ID || JUNC000001 || unique ID for this chimeric junction ||
|| 27 || Junction Pos || 52 || location of breakpoint within junction sequence ||
|| 28 || 5' homology || 2 || number of bases of homology between 5' and 3' partners ||
|| 29 || 3' homology || 2 || number of bases of homology between 3' and 5' partners ||
|| 30 || Spanning reads || 70 || number of reads spanning the breakpoint ||
|| 31 || Intersection of encompassing and spanning reads || 68 || Number of spanning reads that were aligned as encompassing reads during segmented alignment ||
|| 32 || Union of encompassing and spanning reads || 182 || Total number of reads supporting the breakpoint ||
|| 33 || Spanning read descriptors || <not shown> || semicolon-delimited strings with "READ-ID|READ`[0,1]`|SEQUENCE|START|END|MULTIMAPPINGS|STRAND" for each spanning read ||
|| 34 || Breakpoint histogram || 1,2,0,0,0,5,4,3,2,8 || histogram of number reads spanning the breakpoint each anchor length ||
|| 35 || Score || 0.75 || interpolated empirical score used for ranking chimeras ||

== Creating an HTML page for easy viewing of the top candidates in a run ==

A new script, "chimerascan_html_table.py", is now provided that produces a sortable table of the top chimera candidates in a *chimeras.ranked.bedpe* file.  *NOTE: This script requires the Jinja2 python package to be installed, visit [http://jinja.pocoo.org/docs/intro/#installation] to install it*.  The script has two parameters: (1) a threshold for the empirical probability and (2) whether or not to include "read-through" chimeras in the output.

{{{
$ /home/john/chimerascan/bin/chimerascan_html.py -h
Usage: chimerascan_html_table.py [options] <chimeras.ranked.bedpe>

Options:
  -h, --help            show this help message and exit
  -o OUTPUT_FILE        output file [default=stdout]
  --empirical-prob=EMPIRICAL_PROB
                        probability threshold (0-1) [default=0.6]
  --read-throughs       include read-through chimeras in output
                        [default=False]
}}}

For example:
{{{
/home/john/chimerascan/bin/chimerascan_html.py --empirical-prob 1.0 -o myfile.html chimeras.ranked.bedpe
}}}

The output file, *myfile.html* will be written.  You can open it in your favorite web browser.  Javascript should be enabled to facilitate the sorting feature.

= `Chimerascan` command-line options =

*These may change in subsequent release of `chimerascan` and this wiki page may lag the software*. Please run `chimerascan_run.py` with the "-h" option to view the most recent list of options.

Many of chimerascan's options are directly passed to `Bowtie`.  Therefore, users should refer to Bowtie's manual pages for a full explanation of these parameters.

{{{
[myself@mylocation] $ <INSTALL_DIR>/bin/chimerascan_run.py -h
Usage: chimerascan_run.py [options] [--config <config_file>  | <mate1.fq> <mate2.fq> <output_dir>]

Options:
  --version             show program's version number and exit
  -h, --help            show this help message and exit
  --index=INDEX_DIR     Path to chimerascan index directory
  --config=CONFIG_FILE  Path to configuration XML file
  -v, --verbose         enable verbose logging output [default=False]
  -p NUM_PROCESSORS, --processors=NUM_PROCESSORS
                        Number of processor cores to allocate to chimerascan
                        [default=2]
  --keep-tmp            Do not delete intermediate files from run

  Bowtie options:
    Adjust these options to change bowtie alignment settings

    --bowtie-build-bin=BOWTIE_BUILD_BIN
                        Path to 'bowtie-build' program
    --bowtie-bin=BOWTIE_BIN
                        Path to 'bowtie' program
    --bowtie-mode-v     Run bowtie with -v to ignore quality scores
    --multihits=MMAX    Ignore reads that map to more than MMAX locations
                        [default=100]
    --mismatches=N      Aligned reads must have <= N mismatches [default=2]
    --segment-length=SEGMENT_LENGTH
                        Size of read segments during discordant alignment
                        phase [default=25]
    --trim5=N           Trim N bases from 5' end of read
    --trim3=N           Trim N bases from 3' end of read
    --quals=FMT         Choose from solexa,sanger,illumina [default=sanger]
    --min-fragment-length=MIN_FRAGMENT_LENGTH
                        Smallest expected fragment length [default=0]
    --max-fragment-length=MAX_FRAGMENT_LENGTH
                        Largest expected fragment length (reads less than this
                        fragment length are assumed to be  unspliced and
                        contiguous) [default=1000]
    --library=LIBRARY_TYPE
                        Library type ('fr', 'rf') [default=fr]

  Filtering options:
    Adjust these options to change filtering behavior

    --max-indel-size=N  Tolerate indels less than N bp [default=100]
    --anchor-min=ANCHOR_MIN
                        Minimum junction overlap required to call spanning
                        reads [default=0]
    --anchor-max=ANCHOR_MAX
                        Junction overlap below which to enforce mismatch
                        checks [default=5]
    --anchor-mismatches=ANCHOR_MISMATCHES
                        Number of mismatches allowed within anchor region
                        [default=5]
    --filter-multimaps=FILTER_MAX_MULTIMAPS
                        Filter chimeras that lack a read  with <= HITS
                        alternative hits in both  pairs [default=2]
    --filter-multimap-ratio=RATIO
                        Filter chimeras with a weighted coverage versus total
                        reads ratio <= RATIO [default=0.1]
    --filter-isize-stdevs=N
                        Filter chimeras where putative insert size is >N
                        standard deviations from the mean [default=3]
    --filter-strand-pvalue=p
                        p-value to reject chimera based on  binomial test that
                        balance of +/- strand  encompassing reads should be
                        50/50 [default=0.01]
    --empirical-prob=p  empirical probability threshold for outputting
                        chimeras [default=1.0]
}}}

== `Chimerascan` configuration file support ==

Chimerascan supports an XML configuration file containing a run configuration and all command-line options.  All of the XML fields are optional and the command line parameters will always override the XML fields.  At the beginning of each run, a file `runconfig.xml` will be written to the output directory to reflect the exact conglomeration of parameters that were used in that run.

Below is an example working configuration file that you may use as a template:

{{{
<chimerascan_config>
  <output_dir>myout</output_dir>
  <fastq_files>
    <file mate="0">read1.fq</file>
    <file mate="1">read2.fq</file>
  </fastq_files>
  <index>/path/to/hg19_ucsc_index</index>
  <quals>solexa</quals>
  <num_processors>2</num_processors>
  <keep_tmp>False</keep_tmp>
  <bowtie_build_bin>bowtie-build</bowtie_build_bin>
  <bowtie_bin>bowtie</bowtie_bin>
  <bowtie_mode_v>False</bowtie_mode_v>
  <multihits>100</multihits>
  <mismatches>2</mismatches>
  <segment_length>25</segment_length>
  <trim5>0</trim5>
  <trim3>0</trim3>
  <min_fragment_length>0</min_fragment_length>
  <max_fragment_length>1000</max_fragment_length>
  <max_indel_size>100</max_indel_size>
  <library_type>fr</library_type>
  <filter_max_multimaps>2</filter_max_multimaps>
  <filter_multimap_ratio>0.1</filter_multimap_ratio>
  <filter_isize_stdevs>3</filter_isize_stdevs>
  <filter_strand_pval>0.01</filter_strand_pval>
  <anchor_min>0</anchor_min>
  <anchor_max>5</anchor_max>
  <anchor_mismatches>5</anchor_mismatches>
  <empirical_prob>1.0</empirical_prob>
</chimerascan_config>
}}}